# Session Log - 2026-02-22 14:00:00

## What Was Wrong / What Was Requested

Implement MLX Tier 2 pipeline per plan: create MLX/ group with MLXError, ModelDownloadManager, MLXEmbeddingEngine, MLXClauseClassifier, Tier2Engine; add bundled LoRA adapter stub; register files in Xcode; add background session handoff in decodingOppressionApp.

## How I Fixed It / What I Did

1. **MLX/MLXError.swift** — Added enum with `simulatorNotSupported`, `modelUnavailable`, `modelNotLoaded`, `adapterNotFound`.
2. **MLX/ModelDownloadManager.swift** — `@MainActor @Observable` class with `DownloadState` (unavailable/downloading/available), background `URLSession`, Hugging Face API for `mlx-community/Qwen3-4B-4bit` file list, progress tracking, delegate for move-on-completion and `urlSessionDidFinishEvents` → static `sharedBackgroundCompletionHandler` for AppDelegate handoff.
3. **MLX/MLXEmbeddingEngine.swift** — Actor with `#if !targetEnvironment(simulator)` / `#else`; `loadEmbedder` (bge-small-en-v1.5), `embed`, `cosineSimilarity`, `similarity(clause:taxonomyTerm:)`; simulator branch throws `MLXError.simulatorNotSupported`.
4. **MLX/MLXClauseClassifier.swift** — Actor with same simulator guard; init(downloadManager); `loadModel()` from `.available(modelURL)` via `LLMModelFactory.shared.loadContainer(configuration: .init(directory:))`, LoRA from bundle (`Adapters` or `Resources/Adapters`), `ChatSession`; `classify(clause:)` with prompt + regex/fallback parser → `TierClassification(tier: .tier2)`.
5. **MLX/Tier2Engine.swift** — Facade actor holding `embeddingEngine`, `classifier`, `downloadManager`; `classify(clause:)` guards `.available`, lazy `classifier.loadModel()`, returns `TierClassification?`; `isAvailable()` async.
6. **Resources/Adapters/** — `adapter_config.json` (lora_rank/alpha/target_modules), empty `adapters.safetensors`.
7. **Xcode** — MLX group under Recovered References with path `decodingOppression/MLX`, Adapters group path `decodingOppression/Resources/Adapters`; PBXBuildFile for Sources and Resources; membership exceptions updated for MLX and Adapters.
8. **decodingOppressionApp.swift** — `@UIApplicationDelegateAdaptor(AppDelegate.self)`; `AppDelegate` implements `application(_:handleEventsForBackgroundURLSession:completionHandler:)` and sets `ModelDownloadManager.sharedBackgroundCompletionHandler`.

## Challenges Encountered

1. **HubApi** — Plan assumed swift-transformers; used Hugging Face tree API (`/api/models/.../tree/main`) for file list and `URLSession.downloadTask` to avoid extra dependency.
2. **Xcode paths** — Explicit file refs under MLX group were resolved as `MLX/decodingOppression/MLX/...`; fixed by setting group path to `decodingOppression/MLX` and file refs to filename only.
3. **PBXFileSystemSynchronizedRootGroup** — Project uses sync root; kept explicit refs and group paths so build finds files under `app/decodingOppression/decodingOppression/`.

## Next Ideas (6 Ideas)

1. TierResolver (T5) integration to call Tier2Engine.classify when available.
2. Replace adapters.safetensors stub with real T9-trained LoRA.
3. Unit tests for MLXEmbeddingEngine cosineSimilarity and simulator guard.
4. Progress UI bound to ModelDownloadManager.state for download progress.
5. Retry and backoff for model download failures.
6. Localization for MLXError descriptions.
